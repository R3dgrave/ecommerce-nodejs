tags:
  - name: Payments
    description: Procesamiento de pagos y pasarela (Stripe)

paths:
  /payment/create-intent:
    post:
      summary: Crea una intención de pago
      description: Genera un client_secret de Stripe basado en el total de una orden. Requiere que la orden exista y pertenezca al usuario.
      tags:
        - Payments
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PaymentIntentRequest"
      responses:
        200:
          description: Intención de pago creada exitosamente.
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  data:
                    $ref: "#/components/schemas/PaymentIntentResponse"
        400:
          description: Error de lógica de negocio o error de Stripe.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        401:
          description: No autorizado - Token faltante o inválido.
        404:
          description: La orden con el ID proporcionado no existe.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /payment/webhook:
    post:
      summary: Webhook para confirmación de pagos
      description: Endpoint que Stripe llama automáticamente. Actualiza el estado de la orden a 'paid' y descuenta el stock.
      tags:
        - Payments
      responses:
        200:
          description: Evento recibido y procesado correctamente.
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
        400:
          description: Firma del webhook inválida o error en la actualización de base de datos.
          content:
            text/plain:
              schema:
                type: string
                example: "Webhook Error: Firma inválida"

  /payment/config:
    get:
      summary: Obtiene la configuración pública de la pasarela
      description: Retorna la Clave Pública (Publishable Key) necesaria para inicializar Stripe en el frontend.
      tags:
        - Payments
      responses:
        200:
          description: Configuración recuperada exitosamente.
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  publishableKey:
                    type: string
                    example: "pk_test_51Mz..."

  /payment/refund:
    post:
      summary: Reembolsar un pago
      description: Procesa el reembolso en Stripe, cancela la orden y devuelve el stock. Solo accesible por administradores.
      tags:
        - Payments
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RefundRequest"
      responses:
        200:
          description: Reembolso completado y stock devuelto.
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  message: { type: string, example: "Refund processed" }
                  data:
                    $ref: "#/components/schemas/RefundResponse"
        400:
          description: La orden no tiene un pago exitoso o error en la API de Stripe.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        403:
          description: Prohibido - El usuario no tiene permisos de administrador.
        404:
          description: No se encontró la orden o el pago asociado.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
